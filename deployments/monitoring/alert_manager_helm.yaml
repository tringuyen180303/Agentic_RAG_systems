alertmanager:
  fullnameOverride: alertmanager
  enabled: true

  # If you want an AM Ingress later, flip this on and add hosts/tls
  ingress:
    enabled: false

  config:
    global:
      # ⛔ rotate this URL if it was shared publicly
      slack_api_url: "https://discord.com/api/webhooks/1400553953304776714/-wJqMWawnylehX0SCQ_d1ZRUUYMLQrOK6HTQsG2wOTKSWhHyZRaaTSz2QrYN-01JZ60o/slack"
      resolve_timeout: 5m

    receivers:
      - name: "null"
      - name: "discord"
        slack_configs:
          - channel: "k8s"                               # Discord ignores channel; harmless
            icon_url: "https://avatars3.githubusercontent.com/u/3380462"
            username: "Alerts"
            send_resolved: true
            title: |-
              [{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}]
              {{ if ne .CommonAnnotations.summary ""}}{{ .CommonAnnotations.summary }}{{ else }}{{ .CommonLabels.alertname }}{{ end }}
            text: >-
              {{ range .Alerts -}}
              Alert: {{ .Annotations.title }}{{ if .Labels.severity }} - {{ .Labels.severity }}{{ end }}
              Description: {{ if ne .Annotations.description ""}}{{ .Annotations.description }}{{ else }}N/A{{ end }}
              Details:
              {{ range .Labels.SortedPairs }} • {{ .Name }}: {{ .Value }}
              {{ end }}
              {{ end }}

    route:
      group_by: ["alertname", "job"]
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 6h
      receiver: "discord"
      routes:
        # Silence Watchdog to avoid Discord noise
        - receiver: "null"
          match:
            alertname: Watchdog

        # Criticals go to Discord; continue so other matching routes can also run
        - receiver: "discord"
          match_re:
            severity: critical
          continue: true

    inhibit_rules:
      - source_match:
          severity: "critical"
        target_match:
          severity: "warning"
        equal: ["alertname", "namespace"]
